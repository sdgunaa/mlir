# =============================================================================
# Build Dev - Production-Grade LLVM+MLIR Developer Build
# =============================================================================
# Fully idempotent, fault-tolerant developer build workflow.
#
# Produces:
#   - Full LLVM+MLIR shared libraries
#   - All command-line tools
#   - Headers and CMake configuration
#
# Publishes to the SAME GitHub Release as runtime packages.
# Uses strict artifact naming to prevent collision.
#
# Guarantees:
#   ✓ Idempotent - reruns skip completed work
#   ✓ Partial recovery - rebuild only failed platforms
#   ✓ No duplicate releases
#   ✓ No asset collision with release workflow
#   ✓ Deterministic naming
# =============================================================================

name: Build Dev

on:
  workflow_dispatch:
    inputs:
      llvm_version:
        description: 'LLVM version (e.g., 21)'
        required: true
        default: '21'
      llvm_tag:
        description: 'LLVM tag (e.g., llvmorg-21.1.8)'
        required: true
        default: 'llvmorg-21.1.8'
      release_tag:
        description: 'Release tag (e.g., v21.1.8)'
        required: true

permissions:
  contents: write
  actions: read

# Tag-stable concurrency group (separate from release)
# Use ref_name if release_tag input is missing (push events)
concurrency:
  group: dev-${{ github.ref_name || github.event.inputs.release_tag }}
  cancel-in-progress: false

env:
  ARTIFACT_RETENTION_DAYS: 7

jobs:
  # ===========================================================================
  # Job 1: Check State (Idempotency Gate)
  # ===========================================================================
  check-state:
    name: Check State
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.vars.outputs.release_tag }}
      llvm_version: ${{ steps.vars.outputs.llvm_version }}
      llvm_tag: ${{ steps.vars.outputs.llvm_tag }}
      release_exists: ${{ steps.check.outputs.release_exists }}
      linux_dev_asset_exists: ${{ steps.check.outputs.linux_dev_asset_exists }}
      macos_dev_asset_exists: ${{ steps.check.outputs.macos_dev_asset_exists }}
      skip_linux: ${{ steps.check.outputs.skip_linux }}
      skip_macos: ${{ steps.check.outputs.skip_macos }}
      all_complete: ${{ steps.check.outputs.all_complete }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Compute Versions
        id: vars
        run: |
          set -euo pipefail
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RELEASE_TAG="${{ inputs.release_tag }}"
            LLVM_VERSION="${{ inputs.llvm_version }}"
            LLVM_TAG="${{ inputs.llvm_tag }}"
          else
            TAG="${{ github.ref_name }}"
            if [[ "${TAG}" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              LLVM_VERSION="${BASH_REMATCH[1]}"
              LLVM_TAG="llvmorg-${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}"
            else
              LLVM_VERSION="21"
              LLVM_TAG="llvmorg-21.1.8"
            fi
            RELEASE_TAG="${TAG}"
          fi
          
          echo "release_tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"
          echo "llvm_version=${LLVM_VERSION}" >> "$GITHUB_OUTPUT"
          echo "llvm_tag=${LLVM_TAG}" >> "$GITHUB_OUTPUT"
          
          echo "Release Tag: ${RELEASE_TAG}"
          echo "LLVM Version: ${LLVM_VERSION}"
          echo "LLVM Tag: ${LLVM_TAG}"

      - name: Check Release & Dev Assets via gh CLI
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          TAG="${{ steps.vars.outputs.release_tag }}"
          
          # Dev asset names (note the -dev- infix)
          LINUX_DEV_ASSET="llvm+mlir-${TAG}-dev-linux-x86_64.tar.gz"
          MACOS_DEV_ASSET="llvm+mlir-${TAG}-dev-macos-arm64.tar.gz"
          
          echo "Checking release: $TAG"
          
          # Use gh release view for rate-limit safety
          if gh release view "$TAG" --json assets > release.json; then
            echo "release_exists=true" >> "$GITHUB_OUTPUT"
            echo "✅ Release $TAG exists"
            
            # Robust jq check
            has_asset() {
              jq -e --arg name "$1" '.assets[] | select(.name == $name) | .name' release.json >/dev/null
            }
            
            # Check Linux dev asset
            if has_asset "$LINUX_DEV_ASSET"; then
              echo "linux_dev_asset_exists=true" >> "$GITHUB_OUTPUT"
              echo "skip_linux=true" >> "$GITHUB_OUTPUT"
              echo "  ✅ Linux dev asset exists"
            else
              echo "linux_dev_asset_exists=false" >> "$GITHUB_OUTPUT"
              echo "skip_linux=false" >> "$GITHUB_OUTPUT"
              echo "  ❌ Linux dev asset missing"
            fi
            
            # Check macOS dev asset
            if has_asset "$MACOS_DEV_ASSET"; then
              echo "macos_dev_asset_exists=true" >> "$GITHUB_OUTPUT"
              echo "skip_macos=true" >> "$GITHUB_OUTPUT"
              echo "  ✅ macOS dev asset exists"
            else
              echo "macos_dev_asset_exists=false" >> "$GITHUB_OUTPUT"
              echo "skip_macos=false" >> "$GITHUB_OUTPUT"
              echo "  ❌ macOS dev asset missing"
            fi
            
            # Check if all dev assets complete
            if has_asset "$LINUX_DEV_ASSET" && has_asset "$MACOS_DEV_ASSET"; then
              echo "all_complete=true" >> "$GITHUB_OUTPUT"
              echo "✅ All dev assets already exist"
            else
              echo "all_complete=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "release_exists=false" >> "$GITHUB_OUTPUT"
            echo "linux_dev_asset_exists=false" >> "$GITHUB_OUTPUT"
            echo "macos_dev_asset_exists=false" >> "$GITHUB_OUTPUT"
            echo "skip_linux=false" >> "$GITHUB_OUTPUT"
            echo "skip_macos=false" >> "$GITHUB_OUTPUT"
            echo "all_complete=false" >> "$GITHUB_OUTPUT"
            echo "❌ Release $TAG does not exist"
          fi

  # ===========================================================================
  # Job 2: Linux x86_64 Dev Build
  # ===========================================================================
  build-linux-x64:
    name: Linux x86_64 Dev
    needs: check-state
    if: needs.check-state.outputs.skip_linux != 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    outputs:
      status: ${{ steps.result.outputs.status }}
      artifact_name: ${{ steps.package.outputs.artifact_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build python3 zlib1g-dev g++ file ccache

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-dev-linux-${{ needs.check-state.outputs.llvm_tag }}-${{ hashFiles('scripts/build-dev.sh') }}
          restore-keys: |
            ccache-dev-linux-${{ needs.check-state.outputs.llvm_tag }}-

      - name: Cache Build Directory
        uses: actions/cache@v4
        with:
          path: build-llvm-mlir-dev-linux-x64
          # Strict key: dev-linux prefix, script hash required
          key: build-dev-linux-${{ needs.check-state.outputs.llvm_tag }}-${{ hashFiles('scripts/build-dev.sh') }}

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=4G
          ccache --set-config=compression=true
          ccache -z
          echo "CC=ccache gcc" >> "$GITHUB_ENV"
          echo "CXX=ccache g++" >> "$GITHUB_ENV"

      - name: Clone LLVM
        run: |
          LLVM_TAG="${{ needs.check-state.outputs.llvm_tag }}"
          if [[ -d "llvm-project" ]]; then
            cd llvm-project
            # Safe shallow clone fetch
            git fetch --tags --depth=1 origin "$LLVM_TAG" || true
            CURRENT=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
            cd ..
            if [[ "$CURRENT" != "$LLVM_TAG" ]]; then
              rm -rf llvm-project
              git clone --depth=1 --branch="$LLVM_TAG" https://github.com/llvm/llvm-project.git
            else
              echo "Using cached LLVM source at $LLVM_TAG"
            fi
          else
            git clone --depth=1 --branch="$LLVM_TAG" https://github.com/llvm/llvm-project.git
          fi

      - name: Build
        id: build
        run: |
          chmod +x scripts/build-dev.sh
          export LLVM_VERSION="${{ needs.check-state.outputs.llvm_version }}"
          export JOBS=$(nproc)
          ./scripts/build-dev.sh

      - name: Package
        id: package
        run: |
          set -euo pipefail
          TAG="${{ needs.check-state.outputs.release_tag }}"
          
          INSTALL_DIR=$(find . -maxdepth 1 -type d -name "llvm-mlir-dev-*-linux-x64" | head -1)
          if [[ -z "$INSTALL_DIR" ]]; then
            echo "::error::Build output directory not found"
            exit 1
          fi
          
          # Verify mlir-opt exists
          if [[ ! -x "${INSTALL_DIR}/bin/mlir-opt" ]]; then
            echo "::error::mlir-opt not found or not executable"
            exit 1
          fi
          echo "✅ mlir-opt verified"
          
          # Create package with strict dev naming
          PKG_NAME="llvm+mlir-${TAG}-dev-linux-x86_64.tar.gz"
          tar -czf "$PKG_NAME" "$INSTALL_DIR"
          
          echo "Package: $PKG_NAME ($(du -h "$PKG_NAME" | cut -f1))"
          echo "artifact_name=$PKG_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-linux-x64
          path: ${{ steps.package.outputs.artifact_name }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: error

      - name: ccache Stats
        if: always()
        run: ccache -s

      - name: Set Result
        id: result
        if: always()
        run: |
          if [[ "${{ steps.build.outcome }}" == "success" && "${{ steps.package.outcome }}" == "success" ]]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
          fi

  # ===========================================================================
  # Job 3: macOS ARM64 Dev Build
  # ===========================================================================
  build-macos-arm64:
    name: macOS ARM64 Dev
    needs: check-state
    if: needs.check-state.outputs.skip_macos != 'true'
    runs-on: macos-15
    timeout-minutes: 240
    
    outputs:
      status: ${{ steps.result.outputs.status }}
      artifact_name: ${{ steps.package.outputs.artifact_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          brew list cmake &>/dev/null || brew install cmake
          brew list ninja &>/dev/null || brew install ninja
          brew list ccache &>/dev/null || brew install ccache

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/ccache
          key: ccache-dev-macos-${{ needs.check-state.outputs.llvm_tag }}-${{ hashFiles('scripts/build-dev.sh') }}
          restore-keys: |
            ccache-dev-macos-${{ needs.check-state.outputs.llvm_tag }}-

      - name: Cache Build Directory
        uses: actions/cache@v4
        with:
          path: build-llvm-mlir-dev-macos-arm64
          # Strict key: dev-macos prefix, script hash required
          key: build-dev-macos-${{ needs.check-state.outputs.llvm_tag }}-${{ hashFiles('scripts/build-dev.sh') }}

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=4G
          ccache --set-config=compression=true
          ccache -z
          echo "CC=ccache clang" >> "$GITHUB_ENV"
          echo "CXX=ccache clang++" >> "$GITHUB_ENV"

      - name: Clone LLVM
        run: |
          LLVM_TAG="${{ needs.check-state.outputs.llvm_tag }}"
          if [[ -d "llvm-project" ]]; then
            cd llvm-project
            git fetch --tags --depth=1 origin "$LLVM_TAG" || true
            CURRENT=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
            cd ..
            if [[ "$CURRENT" != "$LLVM_TAG" ]]; then
              rm -rf llvm-project
              git clone --depth=1 --branch="$LLVM_TAG" https://github.com/llvm/llvm-project.git
            else
              echo "Using cached LLVM source at $LLVM_TAG"
            fi
          else
            git clone --depth=1 --branch="$LLVM_TAG" https://github.com/llvm/llvm-project.git
          fi

      - name: Build
        id: build
        run: |
          chmod +x scripts/build-dev.sh
          export LLVM_VERSION="${{ needs.check-state.outputs.llvm_version }}"
          export JOBS=$(sysctl -n hw.ncpu)
          ./scripts/build-dev.sh

      - name: Package
        id: package
        run: |
          set -euo pipefail
          TAG="${{ needs.check-state.outputs.release_tag }}"
          
          INSTALL_DIR=$(find . -maxdepth 1 -type d -name "llvm-mlir-dev-*-macos-arm64" | head -1)
          if [[ -z "$INSTALL_DIR" ]]; then
            echo "::error::Build output directory not found"
            exit 1
          fi
          
          if [[ ! -x "${INSTALL_DIR}/bin/mlir-opt" ]]; then
            echo "::error::mlir-opt not found or not executable"
            exit 1
          fi
          echo "✅ mlir-opt verified"
          
          PKG_NAME="llvm+mlir-${TAG}-dev-macos-arm64.tar.gz"
          tar -czf "$PKG_NAME" "$INSTALL_DIR"
          
          echo "Package: $PKG_NAME ($(du -h "$PKG_NAME" | cut -f1))"
          echo "artifact_name=$PKG_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-macos-arm64
          path: ${{ steps.package.outputs.artifact_name }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: error

      - name: ccache Stats
        if: always()
        run: ccache -s

      - name: Set Result
        id: result
        if: always()
        run: |
          if [[ "${{ steps.build.outcome }}" == "success" && "${{ steps.package.outcome }}" == "success" ]]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
          fi

  # ===========================================================================
  # Job 4: Publish Dev Assets
  # ===========================================================================
  publish-release:
    name: Publish Dev Assets
    needs: [check-state, build-linux-x64, build-macos-arm64]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Evaluate Build States
        id: evaluate
        run: |
          set -euo pipefail
          
          LINUX_SKIPPED="${{ needs.check-state.outputs.skip_linux }}"
          MACOS_SKIPPED="${{ needs.check-state.outputs.skip_macos }}"
          LINUX_JOB="${{ needs.build-linux-x64.result }}"
          MACOS_JOB="${{ needs.build-macos-arm64.result }}"
          LINUX_STATUS="${{ needs.build-linux-x64.outputs.status }}"
          MACOS_STATUS="${{ needs.build-macos-arm64.outputs.status }}"
          
          if [[ "$LINUX_SKIPPED" == "true" ]]; then
            LINUX_FINAL="skipped"
          elif [[ "$LINUX_JOB" == "skipped" ]]; then
            LINUX_FINAL="not-run"
          elif [[ "$LINUX_JOB" == "cancelled" ]]; then
            LINUX_FINAL="cancelled"
          elif [[ "$LINUX_STATUS" == "success" ]]; then
            LINUX_FINAL="success"
          else
            LINUX_FINAL="failure"
          fi
          
          if [[ "$MACOS_SKIPPED" == "true" ]]; then
            MACOS_FINAL="skipped"
          elif [[ "$MACOS_JOB" == "skipped" ]]; then
            MACOS_FINAL="not-run"
          elif [[ "$MACOS_JOB" == "cancelled" ]]; then
            MACOS_FINAL="cancelled"
          elif [[ "$MACOS_STATUS" == "success" ]]; then
            MACOS_FINAL="success"
          else
            MACOS_FINAL="failure"
          fi
          
          echo "Linux dev final state: $LINUX_FINAL"
          echo "macOS dev final state: $MACOS_FINAL"
          
          NEW_ARTIFACTS=0
          [[ "$LINUX_FINAL" == "success" ]] && ((NEW_ARTIFACTS++)) || true
          [[ "$MACOS_FINAL" == "success" ]] && ((NEW_ARTIFACTS++)) || true
          
          SUCCESS_COUNT=0
          [[ "$LINUX_FINAL" == "success" || "$LINUX_FINAL" == "skipped" ]] && ((SUCCESS_COUNT++)) || true
          [[ "$MACOS_FINAL" == "success" || "$MACOS_FINAL" == "skipped" ]] && ((SUCCESS_COUNT++)) || true
          
          if [[ $SUCCESS_COUNT -eq 0 ]]; then
            echo "::error::All dev builds failed. No release update."
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
          elif [[ $NEW_ARTIFACTS -eq 0 ]]; then
            echo "All dev assets already exist. Nothing to publish."
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
          fi
          
          echo "linux_final=$LINUX_FINAL" >> "$GITHUB_OUTPUT"
          echo "macos_final=$MACOS_FINAL" >> "$GITHUB_OUTPUT"

      - name: Download Dev Artifacts Only
        if: steps.evaluate.outputs.should_publish == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: dev-*

      - name: Prepare Assets (Overwrite Protection)
        if: steps.evaluate.outputs.should_publish == 'true'
        id: prepare
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p release-assets
          
          TAG="${{ needs.check-state.outputs.release_tag }}"
          
          find artifacts -type f -name "llvm+mlir-${TAG}-dev-linux-x86_64.tar.gz" -exec cp {} release-assets/ \; 2>/dev/null || true
          find artifacts -type f -name "llvm+mlir-${TAG}-dev-macos-arm64.tar.gz" -exec cp {} release-assets/ \; 2>/dev/null || true
          
          # We only upload newly built dev assets, maintaining namespace separation from release workflow.
          # Overwrite protection relies on check-state skipping builds if assets exist.
          
          echo "Dev assets to upload:"
          ls -lh release-assets/ || echo "(none)"

      - name: Publish to GitHub Releases
        if: steps.evaluate.outputs.should_publish == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-state.outputs.release_tag }}
          name: LLVM ${{ needs.check-state.outputs.llvm_version }} + MLIR C API
          files: release-assets/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
