# LLVM + MLIR Release Builder
# Builds LLVM/MLIR C API binaries for Linux x64 and macOS ARM64.
# Supports partial releases if one platform fails.

name: LLVM+MLIR Release

on:
  workflow_dispatch:
    inputs:
      llvm_version:
        description: 'LLVM version (e.g., 21)'
        required: true
        default: '21'
      llvm_branch:
        description: 'LLVM branch (e.g., release/21.x)'
        required: true
        default: 'release/21.x'
      release_tag:
        description: 'Release tag (e.g., v21.1.8)'
        required: true

  push:
    tags: ['v*']

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

env:
  LLVM_VERSION: ${{ github.event.inputs.llvm_version || '21' }}
  LLVM_BRANCH: ${{ github.event.inputs.llvm_branch || 'release/21.x' }}
  RELEASE_TAG: ${{ github.event.inputs.release_tag || github.ref_name }}

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Linux x86_64
  # ─────────────────────────────────────────────────────────────────────────────
  build-linux-x64:
    name: Linux x86_64
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup
        run: |
          sudo apt-get update && sudo apt-get install -y cmake ninja-build python3 zlib1g-dev g++
          git clone --depth=1 --branch=${{ env.LLVM_BRANCH }} https://github.com/llvm/llvm-project.git

      - name: Build
        run: |
          chmod +x build.sh && ./build.sh
        env:
          LLVM_VERSION: ${{ env.LLVM_VERSION }}
          JOBS: 4

      - name: Verify & Package
        id: package
        run: |
          set -e
          DIR=$(ls -d llvm-mlir-*-linux-x64 | head -1)
          
          # Verify C API
          nm -D ${DIR}/lib/libLLVM.so* | grep -q LLVMContextCreate
          nm -D ${DIR}/lib/libMLIR-C.so* | grep -q mlirContextCreate
          
          # Minimal package (libs only)
          mkdir -p ${DIR}-minimal/lib
          cp ${DIR}/lib/*.so* ${DIR}-minimal/lib/
          tar -czf ${DIR}-minimal.tar.gz ${DIR}-minimal
          sha256sum ${DIR}-minimal.tar.gz > ${DIR}-minimal.tar.gz.sha256
          
          # Full package
          tar -czf ${DIR}-full.tar.gz ${DIR}
          sha256sum ${DIR}-full.tar.gz > ${DIR}-full.tar.gz.sha256
          
          ls -lh *.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: llvm-mlir-*-linux-x64*.tar.gz*
          retention-days: 7
          if-no-files-found: error

  # ─────────────────────────────────────────────────────────────────────────────
  # macOS ARM64
  # ─────────────────────────────────────────────────────────────────────────────
  build-macos-arm64:
    name: macOS ARM64
    runs-on: macos-15
    timeout-minutes: 180
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup
        run: |
          brew install cmake ninja || true
          git clone --depth=1 --branch=${{ env.LLVM_BRANCH }} https://github.com/llvm/llvm-project.git

      - name: Build
        run: |
          chmod +x build.sh && ./build.sh
        env:
          LLVM_VERSION: ${{ env.LLVM_VERSION }}
          JOBS: 4

      - name: Verify & Package
        id: package
        run: |
          set -e
          DIR=$(ls -d llvm-mlir-*-macos-arm64 | head -1)
          
          # Verify C API
          nm ${DIR}/lib/libLLVM.dylib | grep -q LLVMContextCreate
          nm ${DIR}/lib/libMLIR-C.dylib | grep -q mlirContextCreate
          
          # Minimal package (libs only)
          mkdir -p ${DIR}-minimal/lib
          cp ${DIR}/lib/*.dylib ${DIR}-minimal/lib/
          tar -czf ${DIR}-minimal.tar.gz ${DIR}-minimal
          shasum -a 256 ${DIR}-minimal.tar.gz > ${DIR}-minimal.tar.gz.sha256
          
          # Full package
          tar -czf ${DIR}-full.tar.gz ${DIR}
          shasum -a 256 ${DIR}-full.tar.gz > ${DIR}-full.tar.gz.sha256
          
          ls -lh *.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: llvm-mlir-*-macos-arm64*.tar.gz*
          retention-days: 7
          if-no-files-found: error

  # ─────────────────────────────────────────────────────────────────────────────
  # Release
  # ─────────────────────────────────────────────────────────────────────────────
  release:
    name: Create Release
    needs: [build-linux-x64, build-macos-arm64]
    runs-on: ubuntu-latest
    if: always() && (needs.build-linux-x64.result == 'success' || needs.build-macos-arm64.result == 'success')

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Prepare
        id: prep
        run: |
          mkdir -p release
          find artifacts -name "*.tar.gz*" -exec cp {} release/ \;
          ls -lh release/
          
          # Status
          echo "linux=${{ needs.build-linux-x64.result == 'success' && '✅' || '❌' }}" >> $GITHUB_OUTPUT
          echo "macos=${{ needs.build-macos-arm64.result == 'success' && '✅' || '❌' }}" >> $GITHUB_OUTPUT

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: LLVM ${{ env.LLVM_VERSION }} + MLIR C API
          body: |
            ## LLVM ${{ env.LLVM_VERSION }} + MLIR C API
            
            | Platform | Status |
            |----------|--------|
            | Linux x86_64 | ${{ steps.prep.outputs.linux }} |
            | macOS ARM64 | ${{ steps.prep.outputs.macos }} |
            
            **Minimal** (~60 MB): Runtime libraries for FFI  
            **Full** (~200 MB): Headers + tools for development
            
            ### Verify
            ```bash
            tar -xzf llvm-mlir-*-minimal.tar.gz
            nm -D llvm-mlir-*/lib/libLLVM.so* | grep LLVMContextCreate  # Linux
            nm llvm-mlir-*/lib/libLLVM.dylib | grep LLVMContextCreate   # macOS
            ```
            
            ### Build Config
            - Branch: `${{ env.LLVM_BRANCH }}`
            - Targets: X86, AArch64, RISCV, NVPTX, AMDGPU, SPIRV
          files: release/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
