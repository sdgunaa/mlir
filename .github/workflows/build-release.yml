# =============================================================================
# LLVM + MLIR Multi-Platform Release Builder
# =============================================================================
#
# Production-grade CI/CD pipeline for building and releasing LLVM and MLIR
# C API binaries. Designed for resilience: partial failures do not block
# the entire release process.
#
# Supported Platforms:
#   - Linux x86_64     (Ubuntu 22.04)
#   - macOS ARM64      (macOS 15 Apple Silicon)
#
# Key Features:
#   - Graceful degradation: releases proceed with available artifacts
#   - Comprehensive error handling and validation
#   - Concurrency control to prevent duplicate runs
#   - Timeouts to prevent hung builds from blocking resources
#   - Retry logic for network operations
#
# Usage:
#   1. Manual: Actions > Run workflow
#   2. Automatic: Push a version tag (e.g., v21.1.8)
#
# =============================================================================

name: LLVM+MLIR Release

on:
  workflow_dispatch:
    inputs:
      llvm_version:
        description: 'LLVM version to build (e.g., 21, 22)'
        required: true
        default: '21'
      llvm_branch:
        description: 'LLVM branch/tag (e.g., release/21.x, release/22.x)'
        required: true
        default: 'release/21.x'
      release_tag:
        description: 'Release tag (e.g., v21.1.8)'
        required: true

  push:
    tags:
      - 'v*'

# =============================================================================
# PERMISSIONS
# Minimal permissions required for this workflow.
# =============================================================================
permissions:
  contents: write
  actions: read

# =============================================================================
# CONCURRENCY CONTROL
# Prevents duplicate workflow runs for the same release tag.
# =============================================================================
concurrency:
  group: release-${{ github.event.inputs.release_tag || github.ref_name }}
  cancel-in-progress: false

# =============================================================================
# ENVIRONMENT DEFAULTS
# =============================================================================
env:
  DEFAULT_JOBS: 4
  ARTIFACT_RETENTION_DAYS: 7

# =============================================================================
# BUILD JOBS
# =============================================================================
jobs:

  # ---------------------------------------------------------------------------
  # Linux x86_64 Build
  # ---------------------------------------------------------------------------
  build-linux-x64:
    name: Linux x86_64
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    continue-on-error: true

    outputs:
      result: ${{ steps.set-result.outputs.status }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate environment
        run: |
          set -euo pipefail
          echo "=== Environment Validation ==="
          echo "Runner OS: ${RUNNER_OS}"
          echo "Runner Arch: ${RUNNER_ARCH}"
          echo "Workspace: ${GITHUB_WORKSPACE}"
          echo "Available disk space:"
          df -h .
          echo ""

      - name: Install build dependencies
        run: |
          set -euo pipefail
          echo "Installing required packages..."
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build python3 zlib1g-dev g++
          
          # Verify installations
          cmake --version
          ninja --version
          g++ --version
          echo "Dependencies installed successfully"

      - name: Clone LLVM source
        id: clone
        run: |
          set -euo pipefail
          BRANCH="${{ github.event.inputs.llvm_branch || 'release/21.x' }}"
          echo "Cloning LLVM from branch: ${BRANCH}"
          
          # Retry logic for network operations
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [[ ${RETRY_COUNT} -lt ${MAX_RETRIES} ]]; do
            if git clone --depth=1 --branch="${BRANCH}" https://github.com/llvm/llvm-project.git; then
              echo "LLVM source cloned successfully"
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [[ ${RETRY_COUNT} -lt ${MAX_RETRIES} ]]; then
              echo "::warning::Clone failed, retrying (${RETRY_COUNT}/${MAX_RETRIES})..."
              sleep 10
              rm -rf llvm-project 2>/dev/null || true
            else
              echo "::error::Failed to clone LLVM repository after ${MAX_RETRIES} attempts"
              exit 1
            fi
          done

      - name: Build LLVM and MLIR
        id: build
        run: |
          set -euo pipefail
          
          if [[ ! -f "build.sh" ]]; then
            echo "::error::build.sh not found in repository root"
            exit 1
          fi
          
          chmod +x build.sh
          echo "Starting build with ${{ env.DEFAULT_JOBS }} parallel jobs..."
          
          if ! ./build.sh; then
            echo "::error::LLVM build failed"
            exit 1
          fi
          echo "Build completed successfully"
        env:
          LLVM_VERSION: ${{ github.event.inputs.llvm_version || '21' }}
          JOBS: 4

      - name: Verify build output
        id: verify
        run: |
          set -euo pipefail
          
          # Expected directory pattern from build.sh
          VERSION="${{ github.event.inputs.llvm_version || '21' }}"
          EXPECTED_DIR="llvm-mlir-${VERSION}-linux-x64"
          
          echo "Looking for build output: ${EXPECTED_DIR}"
          
          if [[ ! -d "${EXPECTED_DIR}" ]]; then
            # Fallback: try to find any matching directory
            INSTALL_DIR=$(ls -d llvm-mlir-*-linux-x64 2>/dev/null | head -1 || true)
            if [[ -z "${INSTALL_DIR}" ]]; then
              echo "::error::Build output directory not found"
              echo "Available directories:"
              ls -la
              exit 1
            fi
            echo "::warning::Using fallback directory: ${INSTALL_DIR}"
          else
            INSTALL_DIR="${EXPECTED_DIR}"
          fi
          
          echo "install_dir=${INSTALL_DIR}" >> $GITHUB_OUTPUT
          echo "Verifying build outputs in: ${INSTALL_DIR}"
          
          # Verify directory structure
          if [[ ! -d "${INSTALL_DIR}/lib" ]]; then
            echo "::error::lib directory not found in ${INSTALL_DIR}"
            exit 1
          fi
          
          # Check LLVM C API
          echo "Checking LLVM C API..."
          LLVM_LIB=$(ls "${INSTALL_DIR}"/lib/libLLVM.so* 2>/dev/null | head -1 || true)
          if [[ -z "${LLVM_LIB}" ]]; then
            echo "::error::libLLVM.so not found"
            exit 1
          fi
          
          if ! nm -D "${LLVM_LIB}" 2>/dev/null | grep -q "LLVMContextCreate"; then
            echo "::error::LLVM C API symbols not found in ${LLVM_LIB}"
            exit 1
          fi
          echo "LLVM C API verified: ${LLVM_LIB}"
          
          # Check MLIR C API
          echo "Checking MLIR C API..."
          MLIR_LIB=$(ls "${INSTALL_DIR}"/lib/libMLIR-C.so* 2>/dev/null | head -1 || true)
          if [[ -z "${MLIR_LIB}" ]]; then
            echo "::error::libMLIR-C.so not found"
            exit 1
          fi
          
          if ! nm -D "${MLIR_LIB}" 2>/dev/null | grep -q "mlirContextCreate"; then
            echo "::error::MLIR C API symbols not found in ${MLIR_LIB}"
            exit 1
          fi
          echo "MLIR C API verified: ${MLIR_LIB}"

      - name: Create distribution packages
        id: package
        run: |
          set -euo pipefail
          
          INSTALL_DIR="${{ steps.verify.outputs.install_dir }}"
          VERSION="${{ github.event.inputs.llvm_version || '21' }}"
          
          echo "Creating distribution packages from: ${INSTALL_DIR}"
          
          # Minimal package: runtime libraries only
          MINIMAL_DIR="${INSTALL_DIR}-minimal"
          echo "Building minimal package..."
          mkdir -p "${MINIMAL_DIR}/lib"
          
          # Copy shared libraries
          LIB_COUNT=$(ls "${INSTALL_DIR}"/lib/*.so* 2>/dev/null | wc -l || echo 0)
          if [[ "${LIB_COUNT}" -eq 0 ]]; then
            echo "::error::No shared libraries found to package"
            exit 1
          fi
          
          cp -r "${INSTALL_DIR}"/lib/*.so* "${MINIMAL_DIR}/lib/"
          echo "LLVM ${VERSION}" > "${MINIMAL_DIR}/lib/version.txt"
          
          # Verify minimal package has content
          MINIMAL_SIZE=$(du -sb "${MINIMAL_DIR}" | cut -f1)
          if [[ "${MINIMAL_SIZE}" -lt 1000000 ]]; then
            echo "::error::Minimal package suspiciously small (${MINIMAL_SIZE} bytes)"
            exit 1
          fi
          echo "Minimal package size: ${MINIMAL_SIZE} bytes"
          
          tar -czf "${MINIMAL_DIR}.tar.gz" "${MINIMAL_DIR}"
          sha256sum "${MINIMAL_DIR}.tar.gz" > "${MINIMAL_DIR}.tar.gz.sha256"
          
          # Full package
          echo "Building full package..."
          tar -czf "${INSTALL_DIR}-full.tar.gz" "${INSTALL_DIR}"
          sha256sum "${INSTALL_DIR}-full.tar.gz" > "${INSTALL_DIR}-full.tar.gz.sha256"
          
          echo "Packages created:"
          ls -lh *.tar.gz
          
          # Verify checksums were created
          echo "Checksums:"
          cat *.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: |
            llvm-mlir-*-linux-x64-minimal.tar.gz
            llvm-mlir-*-linux-x64-minimal.tar.gz.sha256
            llvm-mlir-*-linux-x64-full.tar.gz
            llvm-mlir-*-linux-x64-full.tar.gz.sha256
          retention-days: 7
          if-no-files-found: error

      - name: Set job result
        id: set-result
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

  # ---------------------------------------------------------------------------
  # macOS ARM64 (Apple Silicon) Build
  # ---------------------------------------------------------------------------
  build-macos-arm64:
    name: macOS Apple Silicon (ARM64)
    runs-on: macos-15
    timeout-minutes: 180
    continue-on-error: true

    outputs:
      result: ${{ steps.set-result.outputs.status }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate environment
        run: |
          set -euo pipefail
          echo "=== Environment Validation ==="
          echo "Runner OS: ${RUNNER_OS}"
          echo "Runner Arch: ${RUNNER_ARCH}"
          echo "Workspace: ${GITHUB_WORKSPACE}"
          echo "Available disk space:"
          df -h .
          echo ""

      - name: Install build dependencies
        run: |
          set -euo pipefail
          echo "Installing Homebrew packages..."
          
          # Check if already installed to avoid errors
          brew list cmake &>/dev/null || brew install cmake
          brew list ninja &>/dev/null || brew install ninja
          
          # Verify installations
          cmake --version
          ninja --version
          echo "Dependencies installed"

      - name: Clone LLVM source
        id: clone
        run: |
          set -euo pipefail
          BRANCH="${{ github.event.inputs.llvm_branch || 'release/21.x' }}"
          echo "Cloning LLVM from branch: ${BRANCH}"
          
          # Retry logic for network operations
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [[ ${RETRY_COUNT} -lt ${MAX_RETRIES} ]]; do
            if git clone --depth=1 --branch="${BRANCH}" https://github.com/llvm/llvm-project.git; then
              echo "LLVM source cloned successfully"
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [[ ${RETRY_COUNT} -lt ${MAX_RETRIES} ]]; then
              echo "::warning::Clone failed, retrying (${RETRY_COUNT}/${MAX_RETRIES})..."
              sleep 10
              rm -rf llvm-project 2>/dev/null || true
            else
              echo "::error::Failed to clone LLVM repository after ${MAX_RETRIES} attempts"
              exit 1
            fi
          done

      - name: Build LLVM and MLIR
        id: build
        run: |
          set -euo pipefail
          
          if [[ ! -f "build.sh" ]]; then
            echo "::error::build.sh not found in repository root"
            exit 1
          fi
          
          chmod +x build.sh
          echo "Starting build with ${{ env.DEFAULT_JOBS }} parallel jobs..."
          
          if ! ./build.sh; then
            echo "::error::LLVM build failed"
            exit 1
          fi
          echo "Build completed successfully"
        env:
          LLVM_VERSION: ${{ github.event.inputs.llvm_version || '21' }}
          JOBS: 4

      - name: Verify build output
        id: verify
        run: |
          set -euo pipefail
          
          # Expected directory pattern from build.sh
          VERSION="${{ github.event.inputs.llvm_version || '21' }}"
          EXPECTED_DIR="llvm-mlir-${VERSION}-macos-arm64"
          
          echo "Looking for build output: ${EXPECTED_DIR}"
          
          if [[ ! -d "${EXPECTED_DIR}" ]]; then
            # Fallback: try to find any matching directory
            INSTALL_DIR=$(ls -d llvm-mlir-*-macos-arm64 2>/dev/null | head -1 || true)
            if [[ -z "${INSTALL_DIR}" ]]; then
              echo "::error::Build output directory not found"
              echo "Available directories:"
              ls -la
              exit 1
            fi
            echo "::warning::Using fallback directory: ${INSTALL_DIR}"
          else
            INSTALL_DIR="${EXPECTED_DIR}"
          fi
          
          echo "install_dir=${INSTALL_DIR}" >> $GITHUB_OUTPUT
          echo "Verifying build outputs in: ${INSTALL_DIR}"
          
          # Verify directory structure
          if [[ ! -d "${INSTALL_DIR}/lib" ]]; then
            echo "::error::lib directory not found in ${INSTALL_DIR}"
            exit 1
          fi
          
          # Check LLVM C API
          echo "Checking LLVM C API..."
          LLVM_LIB=$(ls "${INSTALL_DIR}"/lib/libLLVM*.dylib 2>/dev/null | head -1 || true)
          if [[ -z "${LLVM_LIB}" ]]; then
            echo "::error::libLLVM.dylib not found"
            exit 1
          fi
          
          if ! nm "${LLVM_LIB}" 2>/dev/null | grep -q "LLVMContextCreate"; then
            echo "::error::LLVM C API symbols not found in ${LLVM_LIB}"
            exit 1
          fi
          echo "LLVM C API verified: ${LLVM_LIB}"

      - name: Create distribution packages
        id: package
        run: |
          set -euo pipefail
          
          INSTALL_DIR="${{ steps.verify.outputs.install_dir }}"
          VERSION="${{ github.event.inputs.llvm_version || '21' }}"
          
          echo "Creating distribution packages from: ${INSTALL_DIR}"
          
          # Minimal package
          MINIMAL_DIR="${INSTALL_DIR}-minimal"
          echo "Building minimal package..."
          mkdir -p "${MINIMAL_DIR}/lib"
          
          # Copy shared libraries (macOS uses .dylib)
          DYLIB_COUNT=$(ls "${INSTALL_DIR}"/lib/*.dylib 2>/dev/null | wc -l || echo 0)
          SO_COUNT=$(ls "${INSTALL_DIR}"/lib/*.so* 2>/dev/null | wc -l || echo 0)
          
          if [[ "${DYLIB_COUNT}" -gt 0 ]]; then
            cp -r "${INSTALL_DIR}"/lib/*.dylib "${MINIMAL_DIR}/lib/"
          fi
          
          if [[ "${SO_COUNT}" -gt 0 ]]; then
            cp -r "${INSTALL_DIR}"/lib/*.so* "${MINIMAL_DIR}/lib/" 2>/dev/null || true
          fi
          
          if [[ "${DYLIB_COUNT}" -eq 0 ]] && [[ "${SO_COUNT}" -eq 0 ]]; then
            echo "::error::No shared libraries found to package"
            exit 1
          fi
          
          echo "LLVM ${VERSION}" > "${MINIMAL_DIR}/lib/version.txt"
          
          # Verify minimal package has content
          MINIMAL_SIZE=$(du -sk "${MINIMAL_DIR}" | cut -f1)
          MINIMAL_SIZE_BYTES=$((MINIMAL_SIZE * 1024))
          if [[ "${MINIMAL_SIZE_BYTES}" -lt 1000000 ]]; then
            echo "::error::Minimal package suspiciously small (${MINIMAL_SIZE_BYTES} bytes)"
            exit 1
          fi
          echo "Minimal package size: ${MINIMAL_SIZE_BYTES} bytes"
          
          tar -czf "${MINIMAL_DIR}.tar.gz" "${MINIMAL_DIR}"
          shasum -a 256 "${MINIMAL_DIR}.tar.gz" > "${MINIMAL_DIR}.tar.gz.sha256"
          
          # Full package
          echo "Building full package..."
          tar -czf "${INSTALL_DIR}-full.tar.gz" "${INSTALL_DIR}"
          shasum -a 256 "${INSTALL_DIR}-full.tar.gz" > "${INSTALL_DIR}-full.tar.gz.sha256"
          
          echo "Packages created:"
          ls -lh *.tar.gz
          
          # Verify checksums were created
          echo "Checksums:"
          cat *.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: |
            llvm-mlir-*-macos-arm64-minimal.tar.gz
            llvm-mlir-*-macos-arm64-minimal.tar.gz.sha256
            llvm-mlir-*-macos-arm64-full.tar.gz
            llvm-mlir-*-macos-arm64-full.tar.gz.sha256
          retention-days: 7
          if-no-files-found: error

      - name: Set job result
        id: set-result
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

  # ---------------------------------------------------------------------------
  # Create GitHub Release
  # Aggregates available artifacts and publishes a versioned release.
  # Proceeds with partial artifacts if some builds failed.
  # ---------------------------------------------------------------------------
  create-release:
    name: Create Release
    needs: [build-linux-x64, build-macos-arm64]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: always()

    steps:
      - name: Evaluate build results
        id: evaluate
        run: |
          set -euo pipefail
          
          LINUX_RESULT="${{ needs.build-linux-x64.result }}"
          MACOS_RESULT="${{ needs.build-macos-arm64.result }}"
          
          echo "=== Build Results ==="
          echo "Linux x86_64:         ${LINUX_RESULT}"
          echo "macOS Apple Silicon:  ${MACOS_RESULT}"
          echo ""
          
          # Determine if we should proceed
          SUCCESS_COUNT=0
          [[ "${LINUX_RESULT}" == "success" ]] && ((SUCCESS_COUNT++)) || true
          [[ "${MACOS_RESULT}" == "success" ]] && ((SUCCESS_COUNT++)) || true
          
          echo "Successful builds: ${SUCCESS_COUNT}/2"
          
          if [[ ${SUCCESS_COUNT} -eq 0 ]]; then
            echo "::error::All builds failed. Cannot create release."
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "success_count=${SUCCESS_COUNT}" >> $GITHUB_OUTPUT
          
          if [[ ${SUCCESS_COUNT} -lt 2 ]]; then
            echo "::warning::Creating partial release. Some platforms failed."
          fi

      - name: Download available artifacts
        if: steps.evaluate.outputs.should_release == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Prepare release assets
        if: steps.evaluate.outputs.should_release == 'true'
        id: prepare
        run: |
          set -euo pipefail
          
          echo "Collecting release assets..."
          mkdir -p release-assets
          
          # Copy available artifacts
          find artifacts -name "*.tar.gz" -exec cp {} release-assets/ \; 2>/dev/null || true
          find artifacts -name "*.sha256" -exec cp {} release-assets/ \; 2>/dev/null || true
          
          # Validate we have something to release
          PACKAGE_COUNT=$(find release-assets -name "*.tar.gz" 2>/dev/null | wc -l || echo 0)
          echo "Found ${PACKAGE_COUNT} packages"
          
          if [[ "${PACKAGE_COUNT}" -eq 0 ]]; then
            echo "::error::No packages found for release"
            exit 1
          fi
          
          echo "Release assets:"
          ls -lh release-assets/
          
          # Generate availability status
          LINUX_STATUS="Not available"
          MACOS_STATUS="Not available"
          
          [[ "${{ needs.build-linux-x64.result }}" == "success" ]] && LINUX_STATUS="Available"
          [[ "${{ needs.build-macos-arm64.result }}" == "success" ]] && MACOS_STATUS="Available"
          
          echo "linux_status=${LINUX_STATUS}" >> $GITHUB_OUTPUT
          echo "macos_status=${MACOS_STATUS}" >> $GITHUB_OUTPUT

      - name: Publish GitHub release
        if: steps.evaluate.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag || github.ref_name }}
          name: LLVM ${{ github.event.inputs.llvm_version || '21' }} + MLIR C API
          body: |
            # LLVM ${{ github.event.inputs.llvm_version || '21' }} + MLIR C API
            
            Production-ready LLVM and MLIR libraries with full C API support for FFI usage.
            
            ---
            
            ## Package Availability
            
            | Platform | Status | Minimal | Full |
            |----------|--------|---------|------|
            | Linux x86_64 | ${{ steps.prepare.outputs.linux_status }} | `llvm-mlir-${{ github.event.inputs.llvm_version || '21' }}-linux-x64-minimal.tar.gz` | `llvm-mlir-${{ github.event.inputs.llvm_version || '21' }}-linux-x64-full.tar.gz` |
            | macOS Apple Silicon | ${{ steps.prepare.outputs.macos_status }} | `llvm-mlir-${{ github.event.inputs.llvm_version || '21' }}-macos-arm64-minimal.tar.gz` | `llvm-mlir-${{ github.event.inputs.llvm_version || '21' }}-macos-arm64-full.tar.gz` |
            
            **Package Sizes:** Minimal (~50-80 MB) for runtime FFI | Full (~180-220 MB) for development
            
            ---
            
            ## Quick Start
            
            ```bash
            # Extract
            tar -xzf llvm-mlir-*-minimal.tar.gz
            
            # Verify (Linux)
            nm -D llvm-mlir-*/lib/libLLVM.so* | grep LLVMContextCreate
            
            # Verify (macOS)
            nm llvm-mlir-*/lib/libLLVM.dylib | grep LLVMContextCreate
            ```
            
            ---
            
            ## Build Details
            
            | Property | Value |
            |----------|-------|
            | LLVM Branch | `${{ github.event.inputs.llvm_branch || 'release/21.x' }}` |
            | Targets | X86, AArch64, RISCV, NVPTX, AMDGPU, SPIRV |
            | Execution Engine | Enabled |
            | PDL | Enabled |
            | IRDL | Enabled |
            | Transform Dialect | Enabled |
            
            ---
            
            ## Integrity Check
            
            ```bash
            # Linux
            sha256sum -c <package>.tar.gz.sha256
            
            # macOS
            shasum -a 256 -c <package>.tar.gz.sha256
            ```
            
          files: release-assets/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: always()
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux x86_64 | ${{ needs.build-linux-x64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS ARM64 | ${{ needs.build-macos-arm64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.evaluate.outputs.should_release }}" == "true" ]]; then
            echo "Release created with ${{ steps.evaluate.outputs.success_count }}/2 platforms." >> $GITHUB_STEP_SUMMARY
          else
            echo "Release was not created due to build failures." >> $GITHUB_STEP_SUMMARY
          fi
