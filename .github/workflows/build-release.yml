# =============================================================================
# LLVM + MLIR Multi-Platform Release Builder
# =============================================================================
#
# This workflow automates the build and release of LLVM and MLIR C API
# binaries across multiple platforms. It produces both minimal (runtime-only)
# and full (with headers and tools) packages for downstream consumers.
#
# Supported Platforms:
#   - Linux x86_64     (Ubuntu 22.04)
#   - macOS ARM64      (macOS 15 Apple Silicon)
#
# Note: Linux ARM64 (QEMU) and macOS Intel removed due to slow build times.
#
# Usage:
#   1. Manual trigger via Actions > Run workflow
#   2. Automatic trigger on version tags (e.g., v21.1.8)
#
# =============================================================================

name: LLVM+MLIR Release

on:
  # ---------------------------------------------------------------------------
  # Manual Trigger
  # Allows you to build whenever needed with full control over versions.
  # ---------------------------------------------------------------------------
  workflow_dispatch:
    inputs:
      llvm_version:
        description: 'LLVM version to build (e.g., 21, 22)'
        required: true
        default: '21'
      llvm_branch:
        description: 'LLVM branch/tag (e.g., release/21.x, release/22.x)'
        required: true
        default: 'release/21.x'
      release_tag:
        description: 'Release tag (e.g., v21.1.8)'
        required: true

  # ---------------------------------------------------------------------------
  # Automatic Trigger
  # Fires when you push a version tag matching the pattern v*.
  # ---------------------------------------------------------------------------
  push:
    tags:
      - 'v*'

# =============================================================================
# ENVIRONMENT DEFAULTS
# =============================================================================
env:
  DEFAULT_JOBS: 4
  ARTIFACT_RETENTION_DAYS: 7

# =============================================================================
# BUILD JOBS
# =============================================================================
jobs:

  # ---------------------------------------------------------------------------
  # Linux x86_64 Build
  # ---------------------------------------------------------------------------
  build-linux-x64:
    name: Linux x86_64
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          echo "Installing required packages..."
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build python3 zlib1g-dev g++
          echo "Dependencies installed successfully"

      - name: Clone LLVM source
        run: |
          echo "Cloning LLVM from branch: ${{ github.event.inputs.llvm_branch || 'release/21.x' }}"
          git clone --depth=1 --branch=${{ github.event.inputs.llvm_branch || 'release/21.x' }} \
            https://github.com/llvm/llvm-project.git
          echo "LLVM source cloned"

      - name: Build LLVM and MLIR
        run: |
          chmod +x build.sh
          echo "Starting build with ${{ env.DEFAULT_JOBS }} parallel jobs..."
          ./build.sh
        env:
          LLVM_VERSION: ${{ github.event.inputs.llvm_version || '21' }}
          JOBS: 4

      - name: Verify C API symbols
        run: |
          INSTALL_DIR=$(ls -d llvm-mlir-*-linux-x64)
          echo "Verifying build outputs in: ${INSTALL_DIR}"
          
          echo "Checking LLVM C API..."
          nm -D ${INSTALL_DIR}/lib/libLLVM.so* | grep -q "LLVMContextCreate" || exit 1
          echo "LLVM C API verified"
          
          echo "Checking MLIR C API..."
          nm -D ${INSTALL_DIR}/lib/libMLIR-C.so* | grep -q "mlirContextCreate" || exit 1
          echo "MLIR C API verified"

      - name: Create distribution packages
        run: |
          INSTALL_DIR=$(ls -d llvm-mlir-*-linux-x64)
          VERSION=${{ github.event.inputs.llvm_version || '21' }}
          
          echo "Creating distribution packages..."
          
          # Minimal package: runtime libraries only (ideal for FFI consumers)
          echo "Building minimal package (runtime libraries only)..."
          mkdir -p ${INSTALL_DIR}-minimal/lib
          cp -r ${INSTALL_DIR}/lib/*.so* ${INSTALL_DIR}-minimal/lib/
          echo "LLVM ${VERSION}" > ${INSTALL_DIR}-minimal/lib/version.txt
          tar -czf ${INSTALL_DIR}-minimal.tar.gz ${INSTALL_DIR}-minimal
          sha256sum ${INSTALL_DIR}-minimal.tar.gz > ${INSTALL_DIR}-minimal.tar.gz.sha256
          
          # Full package: includes headers and development tools
          echo "Building full package (with headers and tools)..."
          tar -czf ${INSTALL_DIR}-full.tar.gz ${INSTALL_DIR}
          sha256sum ${INSTALL_DIR}-full.tar.gz > ${INSTALL_DIR}-full.tar.gz.sha256
          
          echo "Packages created:"
          ls -lh *.tar.gz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: |
            llvm-mlir-*-linux-x64-minimal.tar.gz*
            llvm-mlir-*-linux-x64-full.tar.gz*
          retention-days: 7

  # ---------------------------------------------------------------------------
  # macOS ARM64 (Apple Silicon) Build
  # ---------------------------------------------------------------------------
  build-macos-arm64:
    name: macOS Apple Silicon (ARM64)
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          echo "Installing Homebrew packages..."
          brew install cmake ninja || true
          # Python 3 is pre-installed on GitHub runners; skip to avoid link conflicts
          echo "Dependencies installed"

      - name: Clone LLVM source
        run: |
          echo "Cloning LLVM from branch: ${{ github.event.inputs.llvm_branch || 'release/21.x' }}"
          git clone --depth=1 --branch=${{ github.event.inputs.llvm_branch || 'release/21.x' }} \
            https://github.com/llvm/llvm-project.git
          echo "LLVM source cloned"

      - name: Build LLVM and MLIR
        run: |
          chmod +x build.sh
          echo "Starting build with ${{ env.DEFAULT_JOBS }} parallel jobs..."
          ./build.sh
        env:
          LLVM_VERSION: ${{ github.event.inputs.llvm_version || '21' }}
          JOBS: 4

      - name: Verify C API symbols
        run: |
          INSTALL_DIR=$(ls -d llvm-mlir-*-macos-arm64)
          echo "Verifying build outputs in: ${INSTALL_DIR}"
          
          echo "Checking LLVM C API..."
          nm -D ${INSTALL_DIR}/lib/libLLVM.dylib 2>/dev/null | grep -q "LLVMContextCreate" || \
          nm ${INSTALL_DIR}/lib/libLLVM.dylib | grep -q "LLVMContextCreate" || exit 1
          echo "LLVM C API verified"

      - name: Create distribution packages
        run: |
          INSTALL_DIR=$(ls -d llvm-mlir-*-macos-arm64)
          VERSION=${{ github.event.inputs.llvm_version || '21' }}
          
          echo "Creating distribution packages..."
          
          # Minimal package
          echo "Building minimal package..."
          mkdir -p ${INSTALL_DIR}-minimal/lib
          cp -r ${INSTALL_DIR}/lib/*.dylib ${INSTALL_DIR}-minimal/lib/ || true
          cp -r ${INSTALL_DIR}/lib/*.so* ${INSTALL_DIR}-minimal/lib/ || true
          echo "LLVM ${VERSION}" > ${INSTALL_DIR}-minimal/lib/version.txt
          tar -czf ${INSTALL_DIR}-minimal.tar.gz ${INSTALL_DIR}-minimal
          shasum -a 256 ${INSTALL_DIR}-minimal.tar.gz > ${INSTALL_DIR}-minimal.tar.gz.sha256
          
          # Full package
          echo "Building full package..."
          tar -czf ${INSTALL_DIR}-full.tar.gz ${INSTALL_DIR}
          shasum -a 256 ${INSTALL_DIR}-full.tar.gz > ${INSTALL_DIR}-full.tar.gz.sha256
          
          echo "Packages created:"
          ls -lh *.tar.gz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: |
            llvm-mlir-*-macos-arm64-minimal.tar.gz*
            llvm-mlir-*-macos-arm64-full.tar.gz*
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Create GitHub Release
  # Aggregates all platform artifacts and publishes a versioned release.
  # ---------------------------------------------------------------------------
  create-release:
    name: Create Release
    needs: [build-linux-x64, build-macos-arm64]
    runs-on: ubuntu-latest

    steps:
      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          echo "Collecting release assets from all platforms..."
          mkdir -p release-assets
          find artifacts -name "*.tar.gz*" -exec cp {} release-assets/ \;
          
          echo "Release assets ready:"
          ls -lh release-assets/

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag || github.ref_name }}
          name: LLVM ${{ github.event.inputs.llvm_version || '21' }} + MLIR C API
          body: |
            # LLVM ${{ github.event.inputs.llvm_version || '21' }} + MLIR C API
            
            Production-ready LLVM and MLIR libraries built with full C API support for FFI usage.
            
            ---
            
            ## Available Packages
            
            | Platform | Minimal (Runtime Only) | Full (Headers + Tools) |
            |----------|------------------------|------------------------|
            | Linux x86_64 | `llvm-mlir-${{ github.event.inputs.llvm_version || '21' }}-linux-x64-minimal.tar.gz` | `llvm-mlir-${{ github.event.inputs.llvm_version || '21' }}-linux-x64-full.tar.gz` |
            | macOS Apple Silicon | `llvm-mlir-${{ github.event.inputs.llvm_version || '21' }}-macos-arm64-minimal.tar.gz` | `llvm-mlir-${{ github.event.inputs.llvm_version || '21' }}-macos-arm64-full.tar.gz` |
            
            **Note:** Use the Minimal package (~50-80 MB) for runtime FFI. Use Full (~180-220 MB) for development.
            
            > Linux ARM64 and macOS Intel builds are available on request (slower build times).
            
            ---
            
            ## Verification
            
            ```bash
            # Extract the package
            tar -xzf llvm-mlir-*-minimal.tar.gz
            
            # Verify C API symbols (Linux)
            nm -D llvm-mlir-*/lib/libLLVM.so* | grep LLVMContextCreate
            
            # Verify C API symbols (macOS)
            nm llvm-mlir-*/lib/libLLVM.dylib | grep LLVMContextCreate
            ```
            
            ---
            
            ## Build Configuration
            
            | Property | Value |
            |----------|-------|
            | LLVM Branch | `${{ github.event.inputs.llvm_branch || 'release/21.x' }}` |
            | Targets | X86, AArch64, RISCV, NVPTX, AMDGPU, SPIRV |
            | Execution Engine | Enabled |
            | PDL (Pattern Description Language) | Enabled |
            | IRDL (IR Definition Language) | Enabled |
            | Transform Dialect | Enabled |
            
            ---
            
            ## Integrity Verification
            
            Each package includes a corresponding `.sha256` file:
            
            ```bash
            sha256sum -c <package-name>.tar.gz.sha256
            ```
            
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
